#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
SERVER="root@45.130.8.3"
PROJECT_DIR="/root/sels"

echo "üöÄ –ù–∞—á–∏–Ω–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π..."

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ GitHub (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è)
echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ GitHub..."
if ./push-to-github.sh; then
    echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ GitHub"
else
    echo "‚ö†Ô∏è  Push –Ω–µ —É–¥–∞–ª—Å—è, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—é –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
fi

# –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üîÑ –û–±–Ω–æ–≤–ª—è—é –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh $SERVER << 'ENDSSH'
cd /root/sels
echo "üì• –ü–æ–ª—É—á–∞—é –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ GitHub..."
git pull origin main

echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é Docker –æ–±—Ä–∞–∑..."
docker compose build --no-cache

echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker compose up -d

echo "‚è≥ –ñ–¥—É 5 —Å–µ–∫—É–Ω–¥..."
sleep 5

echo "üîß –ì–µ–Ω–µ—Ä–∏—Ä—É—é Prisma Client..."
docker compose exec web npx prisma generate

echo "üìä –ü—Ä–∏–º–µ–Ω—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î..."
docker compose exec web npx prisma db push

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –≤–µ–±-—Å–µ—Ä–≤–µ—Ä..."
docker compose restart web

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üìã –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
docker ps --filter "name=sels"
ENDSSH

echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
